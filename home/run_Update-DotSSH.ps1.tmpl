{{ if and .bitwarden .ssh -}}

{{ $destDir := or .chezmoi.config.destDir .chezmoi.homeDir -}}

{{ if not (glob ".ssh/config.d") -}}
New-Item -Path "{{ joinPath $destDir ".ssh/config.d" }}" -ItemType Directory
{{ end -}}

{{ range $host, $element := .ssh -}}
{{ $pubKeyPath := joinPath $destDir ".ssh" (printf "%s.pub" $host) -}}
{{ if not (glob $pubKeyPath) -}}
New-Item -Path "{{ $pubKeyPath }}" -ItemType File -Value "{{ printf "%s %s" (bitwarden "item" (printf "ssh://%s" $host)).sshKey.publicKey $host }}`n"
{{ end }}
{{ $configPath := joinPath $destDir ".ssh" "config.d" $host -}}
{{ if not (glob $configPath) -}}
New-Item -Path "{{ $configPath }}" -ItemType File -Value @"
Host "{{ $host }}"
    IdentityFile "{{ $pubKeyPath }}"
{{ $bitwardenFields := bitwardenFields "item" (printf "ssh://%s" $host) }}
{{ range $key, $value := $element }}
{{ if not (index $bitwardenFields (camelcase $key)) }}
    {{ camelcase $key }} "{{ $value }}"
{{ end }}
{{ end }}
{{ range $key, $field := $bitwardenFields }}
    {{ $key }} "{{ $field.value }}"
{{ end }}
"@
{{ end -}}
{{ end -}}
{{ end -}}
